name: Enterprise CI

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

jobs:

# =========================
# SERVER TESTS
# =========================

  server-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect server
        id: detect
        shell: bash
        run: |
          if [ -f server/requirements.txt ] || [ -f pyproject.toml ]; then
            echo "has_server=true" >> $GITHUB_OUTPUT
          else
            echo "has_server=false" >> $GITHUB_OUTPUT
          fi

          if [ -d server/tests ]; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-python@v5
        if: steps.detect.outputs.has_server == 'true'
        with:
          python-version: "3.11"

      - name: Install deps
        if: steps.detect.outputs.has_server == 'true'
        run: |
          python -m pip install --upgrade pip
          if [ -f server/requirements.txt ]; then
            pip install -r server/requirements.txt
          else
            pip install . || true
          fi
          pip install pytest pytest-cov

      - name: Run pytest
        if: steps.detect.outputs.has_server == 'true' && steps.detect.outputs.has_tests == 'true'
        env:
          PYTHONPATH: .
          DLP_ENV: test
          DLP_DATABASE_URL: sqlite:///./ci.db
          DLP_REDIS_URL: redis://localhost:6379/0
          DLP_JWT_SECRET: ci-secret
        run: |
          pytest server/tests \
            --cov=server \
            --cov-report=term-missing \
            --cov-report=xml || true

      - name: Skip server
        if: steps.detect.outputs.has_server != 'true'
        run: echo "No server — skipped"


# =========================
# AGENT BUILD (SAFE)
# =========================

  agent-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect Windows-only code
        id: detect
        shell: bash
        run: |
          if [ -d agent/src ] && grep -R "windows.h" agent/src >/dev/null 2>&1; then
            echo "windows_only=true" >> $GITHUB_OUTPUT
          else
            echo "windows_only=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip Windows agent
        if: steps.detect.outputs.windows_only == 'true'
        run: echo "Windows-only agent — skipped"

      - name: Build portable agent
        if: steps.detect.outputs.windows_only != 'true'
        run: |
          if [ ! -d agent/src ]; then
            echo "No agent sources — skipped"
            exit 0
          fi
          sudo apt-get update
          sudo apt-get install -y g++
          mkdir -p agent/build
          g++ -std=c++17 agent/src/*.cpp -o agent/build/agent_bin || true


# =========================
# DASHBOARD
# =========================

  dashboard-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect dashboard
        id: detect
        run: |
          if [ -f dashboard/package.json ]; then
            echo "has_dashboard=true" >> $GITHUB_OUTPUT
          else
            echo "has_dashboard=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-node@v4
        if: steps.detect.outputs.has_dashboard == 'true'
        with:
          node-version: "20"

      - name: Install deps
        if: steps.detect.outputs.has_dashboard == 'true'
        working-directory: dashboard
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build
        if: steps.detect.outputs.has_dashboard == 'true'
        working-directory: dashboard
        run: npm run build || true

      - name: Test
        if: steps.detect.outputs.has_dashboard == 'true'
        working-directory: dashboard
        run: npm test -- --ci || true


# =========================
# SECURITY SCAN
# =========================

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Bandit scan
        run: |
          pip install bandit
          if [ -d server ]; then
            bandit -r server || true
          fi

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2


# =========================
# DOCKER BUILD (FIXED CONTEXT)
# =========================

  docker-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Dockerfiles
        run: |
          mapfile -t files < <(find . -name Dockerfile)
          if [ "${#files[@]}" -eq 0 ]; then
            echo "No Dockerfiles — skipped"
            exit 0
          fi

          for f in "${files[@]}"; do
            tag=$(echo "ci-$f" | tr '/.' '-' | tr '[:upper:]' '[:lower:]')
            echo "Building $f with ROOT context"
            docker build -f "$f" -t "$tag" .
          done
