name: Enterprise CI

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:

  server-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect server
        id: detect
        run: |
          [ -d server ] && echo "has_server=true" >> $GITHUB_OUTPUT || echo "has_server=false" >> $GITHUB_OUTPUT
          [ -d server/tests ] && echo "has_tests=true" >> $GITHUB_OUTPUT || echo "has_tests=false" >> $GITHUB_OUTPUT

      - uses: actions/setup-python@v5
        if: steps.detect.outputs.has_server == 'true'
        with:
          python-version: "3.11"

      - name: Install deps
        if: steps.detect.outputs.has_server == 'true'
        run: |
          pip install -U pip
          pip install -r server/requirements.txt pytest pytest-cov

      - name: Run pytest
        if: steps.detect.outputs.has_tests == 'true'
        env:
          PYTHONPATH: .
          DLP_ENV: test
          DLP_DATABASE_URL: sqlite:///./ci.db
          DLP_JWT_SECRET: ci-secret-value-with-sufficient-length
          DLP_ADMIN_PASSWORD: ci-admin-password-value-strong
          DLP_ALLOWED_ORIGINS: '["http://localhost:3000"]'
        run: pytest server/tests --cov=server --cov-report=xml


  agent-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect Windows-only code
        id: detect
        run: |
          if [ -d agent/src ] && grep -R "windows.h" agent/src >/dev/null 2>&1; then
            echo "windows_only=true" >> $GITHUB_OUTPUT
          else
            echo "windows_only=false" >> $GITHUB_OUTPUT
          fi

      - name: Build portable agent
        if: steps.detect.outputs.windows_only != 'true'
        run: |
          [ -d agent/src ] || exit 0
          sudo apt-get update
          sudo apt-get install -y g++
          mkdir -p agent/build
          g++ -std=c++17 agent/src/*.cpp -o agent/build/agent_bin


  dashboard-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect dashboard
        id: detect
        run: |
          [ -f dashboard/package.json ] && echo "has_dashboard=true" >> $GITHUB_OUTPUT || echo "has_dashboard=false" >> $GITHUB_OUTPUT

      - uses: actions/setup-node@v4
        if: steps.detect.outputs.has_dashboard == 'true'
        with:
          node-version: "20"

      - name: Install deps
        if: steps.detect.outputs.has_dashboard == 'true'
        working-directory: dashboard
        run: |
          if [ -f package-lock.json ]; then
            npm ci --ignore-scripts
          else
            npm install --ignore-scripts
          fi

      - name: Build
        if: steps.detect.outputs.has_dashboard == 'true'
        working-directory: dashboard
        run: npm run build

      - name: Test (optional)
        if: steps.detect.outputs.has_dashboard == 'true'
        working-directory: dashboard
        run: |
          if npm run | grep -q test; then
            npm test -- --ci
          else
            echo "No dashboard tests — skipped"
          fi


  security-scan:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Bandit
        run: |
          pip install bandit
          bandit -r server || true

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true


  docker-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
  
      - name: Build Dockerfiles with correct context
        shell: bash
        run: |
          set -euo pipefail
  
          mapfile -t files < <(find . -name Dockerfile)
  
          if [ "${#files[@]}" -eq 0 ]; then
            echo "No Dockerfiles — skipped"
            exit 0
          fi
  
          for f in "${files[@]}"; do
            tag=$(echo "ci-$f" | tr '/.' '-' | tr '[:upper:]' '[:lower:]')
  
            if [[ "$f" == *"dashboard/Dockerfile"* ]]; then
              ctx="./dashboard"
            elif [[ "$f" == *"server/Dockerfile"* ]]; then
              ctx="."
            else
              ctx=$(dirname "$f")
            fi
  
            echo "------------------------"
            echo "Dockerfile: $f"
            echo "Context: $ctx"
            echo "Tag: $tag"
            echo "------------------------"
  
            docker build -f "$f" -t "$tag" "$ctx"
          done

