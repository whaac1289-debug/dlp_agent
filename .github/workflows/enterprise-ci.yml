name: Enterprise CI

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

jobs:

# =====================================================
# SERVER — Python backend auto detect + tests
# =====================================================

  server-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Detect server
        id: detect
        shell: bash
        run: |
          if [ -f server/requirements.txt ] || [ -f pyproject.toml ]; then
            echo "has_server=true" >> $GITHUB_OUTPUT
          else
            echo "has_server=false" >> $GITHUB_OUTPUT
          fi

          if [ -d server/tests ] && find server/tests -name "test_*.py" | grep -q .; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python
        if: steps.detect.outputs.has_server == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        if: steps.detect.outputs.has_server == 'true'
        run: |
          python -m pip install --upgrade pip
          if [ -f server/requirements.txt ]; then
            pip install -r server/requirements.txt
          else
            pip install .
          fi
          pip install pytest pytest-cov

      - name: Run tests
        if: steps.detect.outputs.has_server == 'true' && steps.detect.outputs.has_tests == 'true'
        env:
          PYTHONPATH: .
          DLP_ENV: test
        run: |
          pytest server/tests \
            --cov=server \
            --cov-report=term-missing \
            --cov-report=xml

      - name: Server skip
        if: steps.detect.outputs.has_server != 'true'
        run: echo "No Python server detected — skipping."


# =====================================================
# AGENT — user mode C++ only (driver skip)
# =====================================================

   agent-build:
    runs-on: ubuntu-latest
  
    steps:
      - uses: actions/checkout@v4
  
      - name: Detect agent platform
        id: detect
        shell: bash
        run: |
          if rg -n "#include\s*<windows\.h>" agent/src >/dev/null 2>&1; then
            echo "windows_only=true" >> $GITHUB_OUTPUT
          else
            echo "windows_only=false" >> $GITHUB_OUTPUT
          fi
  
      - name: Skip Windows-only agent
        if: steps.detect.outputs.windows_only == 'true'
        run: echo "Windows-only agent detected — skipping build on Linux runner."
  
      - name: Build portable C++ agent
        if: steps.detect.outputs.windows_only != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y g++
          mkdir -p agent/build
          g++ -std=c++17 agent/src/*.cpp -o agent/build/agent_bin


# =====================================================
# DASHBOARD — Node frontend
# =====================================================

  dashboard-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Detect dashboard
        id: dash
        run: |
          if [ -f dashboard/package.json ]; then
            echo "has_dash=true" >> $GITHUB_OUTPUT
          else
            echo "has_dash=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node
        if: steps.dash.outputs.has_dash == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        if: steps.dash.outputs.has_dash == 'true'
        working-directory: dashboard
        run: npm ci || npm install

      - name: Build
        if: steps.dash.outputs.has_dash == 'true'
        working-directory: dashboard
        run: npm run build

      - name: Test
        if: steps.dash.outputs.has_dash == 'true'
        working-directory: dashboard
        run: npm test --if-present


# =====================================================
# SECURITY SCAN
# =====================================================

  security-scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Python security
        if: ${{ hashFiles('server/requirements.txt', 'pyproject.toml') != '' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Bandit
        if: ${{ hashFiles('server/requirements.txt', 'pyproject.toml') != '' }}
        run: |
          pip install bandit
          bandit -r server || true

      - name: Node audit
        if: ${{ hashFiles('dashboard/package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: npm audit
        if: ${{ hashFiles('dashboard/package.json') != '' }}
        working-directory: dashboard
        run: npm audit --audit-level=high || true


# =====================================================
# DOCKER BUILD (safe detect — no job-level hashFiles)
# =====================================================

  docker-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Detect dockerfiles
        id: docker
        run: |
          if find . -name Dockerfile | grep -q .; then
            echo "has_docker=true" >> $GITHUB_OUTPUT
          else
            echo "has_docker=false" >> $GITHUB_OUTPUT
          fi

      - name: Build images
        if: steps.docker.outputs.has_docker == 'true'
        run: |
          for f in $(find . -name Dockerfile); do
            d=$(dirname "$f")
            tag="ci-$(basename "$d")"
            docker build -f "$f" -t "$tag" "$d"
          done

      - name: Docker skip
        if: steps.docker.outputs.has_docker != 'true'
        run: echo "No Dockerfiles — skip"
