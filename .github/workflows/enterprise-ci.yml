name: Enterprise CI

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

jobs:

# =====================================================
# SERVER — Python backend auto detect + tests
# =====================================================

  server-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Detect server
        id: detect
        shell: bash
        run: |
          if [ -f server/requirements.txt ] || [ -f pyproject.toml ]; then
            echo "has_server=true" >> $GITHUB_OUTPUT
          else
            echo "has_server=false" >> $GITHUB_OUTPUT
          fi

          if [ -d server/tests ] && find server/tests -name "test_*.py" | grep -q .; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python
        if: steps.detect.outputs.has_server == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        if: steps.detect.outputs.has_server == 'true'
        run: |
          python -m pip install --upgrade pip
          if [ -f server/requirements.txt ]; then
            pip install -r server/requirements.txt
          else
            pip install .
          fi
          pip install pytest pytest-cov

      - name: Run tests
        if: steps.detect.outputs.has_server == 'true' && steps.detect.outputs.has_tests == 'true'
        env:
          PYTHONPATH: .
          DLP_ENV: test
        run: |
          pytest server/tests \
            --cov=server \
            --cov-report=term-missing \
            --cov-report=xml

      - name: Server skip
        if: steps.detect.outputs.has_server != 'true'
        run: echo "No Python server detected — skipping."


# =====================================================
# AGENT — user mode C++ only (driver skip)
# =====================================================

  agent-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build agent (user mode)
        shell: bash
        run: |
          if [ ! -d agent ]; then
            echo "No agent dir — skip"
            exit 0
          fi

          if [ -d agent/drivers ]; then
            echo "Kernel driver detected — skipped (WDK required)"
          fi

          if [ -f agent/CMakeLists.txt ]; then
            sudo apt-get update
            sudo apt-get install -y cmake g++
            cmake -S agent -B agent/build
            cmake --build agent/build
            exit 0
          fi

          if [ -f agent/Makefile ]; then
            sudo apt-get update
            sudo apt-get install -y g++
            make -C agent
            exit 0
          fi

          if find agent/src -name "*.cpp" | grep -q .; then
            sudo apt-get update
            sudo apt-get install -y g++
            mkdir -p agent/build
            g++ -std=c++17 agent/src/*.cpp -o agent/build/agent_bin
            echo "User-mode agent compiled"
            exit 0
          fi

          echo "No buildable agent sources — skip"


# =====================================================
# DASHBOARD — Node frontend
# =====================================================

  dashboard-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Detect dashboard
        id: dash
        run: |
          if [ -f dashboard/package.json ]; then
            echo "has_dash=true" >> $GITHUB_OUTPUT
          else
            echo "has_dash=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node
        if: steps.dash.outputs.has_dash == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        if: steps.dash.outputs.has_dash == 'true'
        working-directory: dashboard
        run: npm ci || npm install

      - name: Build
        if: steps.dash.outputs.has_dash == 'true'
        working-directory: dashboard
        run: npm run build

      - name: Test
        if: steps.dash.outputs.has_dash == 'true'
        working-directory: dashboard
        run: npm test --if-present


# =====================================================
# SECURITY SCAN
# =====================================================

  security-scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Python security
        if: ${{ hashFiles('server/requirements.txt', 'pyproject.toml') != '' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Bandit
        if: ${{ hashFiles('server/requirements.txt', 'pyproject.toml') != '' }}
        run: |
          pip install bandit
          bandit -r server || true

      - name: Node audit
        if: ${{ hashFiles('dashboard/package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: npm audit
        if: ${{ hashFiles('dashboard/package.json') != '' }}
        working-directory: dashboard
        run: npm audit --audit-level=high || true


# =====================================================
# DOCKER BUILD (safe detect — no job-level hashFiles)
# =====================================================

  docker-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Detect dockerfiles
        id: docker
        run: |
          if find . -name Dockerfile | grep -q .; then
            echo "has_docker=true" >> $GITHUB_OUTPUT
          else
            echo "has_docker=false" >> $GITHUB_OUTPUT
          fi

      - name: Build images
        if: steps.docker.outputs.has_docker == 'true'
        run: |
          for f in $(find . -name Dockerfile); do
            d=$(dirname "$f")
            tag="ci-$(basename "$d")"
            docker build -f "$f" -t "$tag" "$d"
          done

      - name: Docker skip
        if: steps.docker.outputs.has_docker != 'true'
        run: echo "No Dockerfiles — skip"
