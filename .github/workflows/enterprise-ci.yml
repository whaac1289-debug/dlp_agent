name: Enterprise Hardened CI

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:

# =========================
# CODEQL (SAST)
# =========================

  codeql:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: github/codeql-action/init@v3
        with:
          languages: python, javascript, cpp

      - uses: github/codeql-action/analyze@v3


# =========================
# SERVER TEST + COVERAGE GATE
# =========================

  server-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: python -m pip install --upgrade pip

      - name: Install server deps
        run: |
          if [ -f server/requirements.txt ]; then
            pip install -r server/requirements.txt
          else
            pip install .
          fi

          pip install pytest pytest-cov bandit pip-audit semgrep

      - name: Pytest + coverage
        env:
          PYTHONPATH: .
          DLP_ENV: test
          DLP_DATABASE_URL: sqlite:///./ci.db
          DLP_REDIS_URL: redis://localhost:6379/0
          DLP_JWT_SECRET: ci-secret-value-with-sufficient-length
          DLP_ADMIN_EMAIL: admin@example.com
          DLP_ADMIN_PASSWORD: strong-ci-password-value
          DLP_LICENSE_KEY: ci-license-key
          DLP_ENROLLMENT_SIGNING_SECRET: strong-enroll-secret
          DLP_ALLOWED_ORIGINS: '["http://localhost:3000"]'
        run: |
          pytest server/tests \
            --cov=server \
            --cov-report=xml \
            --cov-fail-under=60


# =========================
# PYTHON SECURITY SCANS
# =========================

  python-security:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: |
          pip install bandit pip-audit semgrep

      - run: bandit -r server

      - run: pip-audit

      - run: semgrep --config=p/ci server


# =========================
# AGENT STATIC ANALYSIS
# =========================

  agent-static:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: C++ static scan
        run: |
          if [ -d agent/src ]; then
            cppcheck --enable=all --error-exitcode=1 agent/src
          else
            echo "No agent/src â€” skip"
          fi


# =========================
# DASHBOARD BUILD + AUDIT
# =========================

  dashboard:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Detect dashboard
        id: detect
        run: |
          if [ -f dashboard/package.json ]; then
            echo "ok=true" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-node@v4
        if: steps.detect.outputs.ok == 'true'
        with:
          node-version: 20

      - name: Install
        if: steps.detect.outputs.ok == 'true'
        working-directory: dashboard
        run: npm ci --ignore-scripts

      - name: Build
        if: steps.detect.outputs.ok == 'true'
        working-directory: dashboard
        run: npm run build

      - name: Test
        if: steps.detect.outputs.ok == 'true'
        working-directory: dashboard
        run: npm test -- --ci

      - name: Dependency audit
        if: steps.detect.outputs.ok == 'true'
        working-directory: dashboard
        run: npm audit --audit-level=high


# =========================
# SECRETS SCAN
# =========================

  secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: gitleaks/gitleaks-action@v2


# =========================
# DOCKER BUILD + SCAN
# =========================

  docker:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build images
        run: |
          set -e
          for f in $(find . -name Dockerfile); do
            dir=$(dirname "$f")
            tag=$(echo "$f" | tr '/.' '-' | tr A-Z a-z)
            docker build -f "$f" -t "$tag" "$dir"
          done

      - name: Install trivy
        run: |
          sudo apt-get install -y wget
          wget -qO- https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.0_Linux-64bit.tar.gz | tar zx
          sudo mv trivy /usr/local/bin/

      - name: Scan images
        run: |
          for img in $(docker images --format "{{.Repository}}" | grep dockerfile); do
            trivy image --exit-code 1 --severity HIGH,CRITICAL "$img"
          done
