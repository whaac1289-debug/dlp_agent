name: CI

on:
  push:
    branches: ["**"]
  pull_request:

permissions:
  contents: read

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      has_python: ${{ steps.detect.outputs.has_python }}
      has_python_tests: ${{ steps.detect.outputs.has_python_tests }}
      python_tests_dir: ${{ steps.detect.outputs.python_tests_dir }}
      has_postgres: ${{ steps.detect.outputs.has_postgres }}
      has_agent_dir: ${{ steps.detect.outputs.has_agent_dir }}
      has_dashboard_dir: ${{ steps.detect.outputs.has_dashboard_dir }}
      node_manager: ${{ steps.detect.outputs.node_manager }}
      has_dockerfiles: ${{ steps.detect.outputs.has_dockerfiles }}
      has_server_dockerfile: ${{ steps.detect.outputs.has_server_dockerfile }}
      has_dashboard_dockerfile: ${{ steps.detect.outputs.has_dashboard_dockerfile }}
      agent_build_system: ${{ steps.detect.outputs.agent_build_system }}
    steps:
      - uses: actions/checkout@v4

      - id: detect
        name: Detect project layout and stack
        shell: bash
        run: |
          set -euo pipefail

          has_python=false
          [[ -f server/requirements.txt ]] && has_python=true

          python_tests_dir=""
          if [[ -d server/tests ]]; then
            python_tests_dir="server/tests"
          else
            candidate="$(find . -type d -name tests -not -path './dashboard/node_modules/*' | head -n 1 || true)"
            python_tests_dir="${candidate#./}"
          fi
          has_python_tests=false
          [[ -n "$python_tests_dir" ]] && has_python_tests=true

          has_postgres=false
          if rg -qi "psycopg2|postgres|postgresql" server/requirements.txt server/config server/models deploy/docker/docker-compose.yml 2>/dev/null; then
            has_postgres=true
          fi

          has_agent_dir=false
          [[ -d agent ]] && has_agent_dir=true

          has_dashboard_dir=false
          [[ -f dashboard/package.json ]] && has_dashboard_dir=true

          node_manager="none"
          if [[ -f dashboard/pnpm-lock.yaml ]]; then
            node_manager="pnpm"
          elif [[ -f dashboard/yarn.lock ]]; then
            node_manager="yarn"
          elif [[ -f dashboard/package-lock.json ]]; then
            node_manager="npm-ci"
          elif [[ -f dashboard/package.json ]]; then
            node_manager="npm"
          fi

          has_dockerfiles=false
          [[ -f server/Dockerfile || -f dashboard/Dockerfile ]] && has_dockerfiles=true

          has_server_dockerfile=false
          [[ -f server/Dockerfile ]] && has_server_dockerfile=true

          has_dashboard_dockerfile=false
          [[ -f dashboard/Dockerfile ]] && has_dashboard_dockerfile=true

          agent_build_system="none"
          if [[ -d agent ]]; then
            if [[ -f agent/CMakeLists.txt ]]; then
              agent_build_system="cmake"
            elif [[ -f Makefile ]]; then
              agent_build_system="make"
            fi
          fi

          echo "has_python=$has_python" >> "$GITHUB_OUTPUT"
          echo "has_python_tests=$has_python_tests" >> "$GITHUB_OUTPUT"
          echo "python_tests_dir=$python_tests_dir" >> "$GITHUB_OUTPUT"
          echo "has_postgres=$has_postgres" >> "$GITHUB_OUTPUT"
          echo "has_agent_dir=$has_agent_dir" >> "$GITHUB_OUTPUT"
          echo "has_dashboard_dir=$has_dashboard_dir" >> "$GITHUB_OUTPUT"
          echo "node_manager=$node_manager" >> "$GITHUB_OUTPUT"
          echo "has_dockerfiles=$has_dockerfiles" >> "$GITHUB_OUTPUT"
          echo "has_server_dockerfile=$has_server_dockerfile" >> "$GITHUB_OUTPUT"
          echo "has_dashboard_dockerfile=$has_dashboard_dockerfile" >> "$GITHUB_OUTPUT"
          echo "agent_build_system=$agent_build_system" >> "$GITHUB_OUTPUT"

  server-tests-postgres:
    needs: detect
    if: needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_postgres == 'true'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: dlp
          POSTGRES_USER: dlp
          POSTGRES_PASSWORD: dlp
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U dlp -d dlp"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      PYTHONPATH: .
      DLP_ENV: test
      DLP_JWT_SECRET: test-secret
      DLP_DATABASE_URL: postgresql+psycopg2://dlp:dlp@localhost:5432/dlp
      DLP_REDIS_URL: redis://localhost:6379/0
      DLP_ADMIN_EMAIL: admin@example.com
      DLP_ADMIN_PASSWORD: Admin-Password-123!
      DLP_LICENSE_KEY: license-test
      DLP_ENROLLMENT_SIGNING_SECRET: enroll-secret
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: server/requirements.txt

      - name: Install server dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r server/requirements.txt
          pip install pytest pytest-cov bandit pip-audit

      - name: Create smoke API test when no tests are present
        if: needs.detect.outputs.has_python_tests != 'true'
        run: |
          mkdir -p server/tests
          cat > server/tests/test_smoke_api.py <<'PY'
          from fastapi.testclient import TestClient
          from server.main import create_app

          def test_health_or_openapi_accessible():
              app = create_app()
              client = TestClient(app)
              response = client.get('/openapi.json')
              assert response.status_code == 200
          PY

      - name: Run pytest with coverage
        run: |
          TEST_DIR="${{ needs.detect.outputs.python_tests_dir }}"
          if [[ -z "$TEST_DIR" ]]; then TEST_DIR="server/tests"; fi
          pytest "$TEST_DIR" --cov=server --cov-report=term-missing --cov-report=xml

  server-tests:
    needs: detect
    if: needs.detect.outputs.has_python == 'true' && needs.detect.outputs.has_postgres != 'true'
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: .
      DLP_ENV: test
      DLP_JWT_SECRET: test-secret
      DLP_DATABASE_URL: sqlite://
      DLP_REDIS_URL: redis://localhost:6379/0
      DLP_ADMIN_EMAIL: admin@example.com
      DLP_ADMIN_PASSWORD: Admin-Password-123!
      DLP_LICENSE_KEY: license-test
      DLP_ENROLLMENT_SIGNING_SECRET: enroll-secret
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: server/requirements.txt

      - name: Install server dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r server/requirements.txt
          pip install pytest pytest-cov bandit pip-audit

      - name: Create smoke API test when no tests are present
        if: needs.detect.outputs.has_python_tests != 'true'
        run: |
          mkdir -p server/tests
          cat > server/tests/test_smoke_api.py <<'PY'
          from fastapi.testclient import TestClient
          from server.main import create_app

          def test_health_or_openapi_accessible():
              app = create_app()
              client = TestClient(app)
              response = client.get('/openapi.json')
              assert response.status_code == 200
          PY

      - name: Run pytest with coverage
        run: |
          TEST_DIR="${{ needs.detect.outputs.python_tests_dir }}"
          if [[ -z "$TEST_DIR" ]]; then TEST_DIR="server/tests"; fi
          pytest "$TEST_DIR" --cov=server --cov-report=term-missing --cov-report=xml

  security:
    needs: detect
    if: needs.detect.outputs.has_python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: server/requirements.txt

      - name: Install security tooling
        run: |
          python -m pip install --upgrade pip
          pip install -r server/requirements.txt
          pip install bandit pip-audit semgrep

      - name: Bandit (Python SAST)
        run: bandit -r server -x server/tests

      - name: pip-audit
        run: pip-audit -r server/requirements.txt

      - name: Semgrep SAST
        run: semgrep scan --config auto --error

  agent-build:
    needs: detect
    if: needs.detect.outputs.has_agent_dir == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build agent (auto-detected build system)
        continue-on-error: true
        run: |
          BUILD_SYSTEM="${{ needs.detect.outputs.agent_build_system }}"
          if [[ "$BUILD_SYSTEM" == "cmake" ]]; then
            cmake -S agent -B agent/build
            cmake --build agent/build --config Release
          elif [[ "$BUILD_SYSTEM" == "make" ]]; then
            make agent-build
          else
            echo "No recognized build system for agent; skipping build."
          fi

  dashboard-build:
    needs: detect
    if: needs.detect.outputs.has_dashboard_dir == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: dashboard
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Node dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.cache/pnpm
            .yarn/cache
          key: ${{ runner.os }}-node-${{ needs.detect.outputs.node_manager }}-${{ hashFiles('dashboard/package.json', 'dashboard/package-lock.json', 'dashboard/yarn.lock', 'dashboard/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ needs.detect.outputs.node_manager }}-

      - name: Enable Corepack for pnpm/yarn
        if: needs.detect.outputs.node_manager == 'pnpm' || needs.detect.outputs.node_manager == 'yarn'
        run: corepack enable

      - name: Install frontend dependencies
        run: |
          PM="${{ needs.detect.outputs.node_manager }}"
          if [[ "$PM" == "pnpm" ]]; then
            pnpm install --frozen-lockfile
          elif [[ "$PM" == "yarn" ]]; then
            yarn install --frozen-lockfile
          elif [[ "$PM" == "npm-ci" ]]; then
            npm ci
          elif [[ "$PM" == "npm" ]]; then
            npm install
          else
            echo "No Node package manager detected; skipping install."
          fi

      - name: Build frontend
        run: |
          if [[ -f package.json ]]; then
            npm run build
          else
            echo "dashboard/package.json not found; skipping build."
          fi

  docker:
    needs: detect
    if: needs.detect.outputs.has_dockerfiles == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build server Docker image
        if: needs.detect.outputs.has_server_dockerfile == 'true'
        run: docker build -f server/Dockerfile -t dlp-server-ci .

      - name: Build dashboard Docker image
        if: needs.detect.outputs.has_dashboard_dockerfile == 'true'
        run: docker build -f dashboard/Dockerfile -t dlp-dashboard-ci .

      - name: Smoke test server image
        if: needs.detect.outputs.has_server_dockerfile == 'true'
        run: docker run --rm dlp-server-ci python --version

      - name: Smoke test dashboard image
        if: needs.detect.outputs.has_dashboard_dockerfile == 'true'
        run: |
          docker run -d --name dlp-dashboard-smoke -p 8080:80 dlp-dashboard-ci
          sleep 5
          curl -fsS http://localhost:8080 >/dev/null
          docker rm -f dlp-dashboard-smoke
